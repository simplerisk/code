function closeSearchBox()
{
  document.getElementById("selections").style.display = "none";
}

function check_id()
{
//  elements = document.getElementsByClassName("id");
//  checkbox = document.getElementById("checkbox_id");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
} 

function check_status()
{
//  elements = document.getElementsByClassName("status");
//  checkbox = document.getElementById("checkbox_risk_status");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_subject()
{
//  elements = document.getElementsByClassName("subject");
//  checkbox = document.getElementById("checkbox_subject");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_reference_id()
{
//  elements = document.getElementsByClassName("reference_id");
//  checkbox = document.getElementById("checkbox_reference_id");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_regulation()
{
//  elements = document.getElementsByClassName("regulation");
//  checkbox = document.getElementById("checkbox_regulation");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_control_number()
{
//  elements = document.getElementsByClassName("control_number");
//  checkbox = document.getElementById("checkbox_control_number");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_location()
{
//  elements = document.getElementsByClassName("location");
//  checkbox = document.getElementById("checkbox_location");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_source()
{
//  elements = document.getElementsByClassName("source");
//  checkbox = document.getElementById("checkbox_source");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_category()
{
//  elements = document.getElementsByClassName("category");
//  checkbox = document.getElementById("checkbox_category");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_team()
{
//  elements = document.getElementsByClassName("team");
//  checkbox = document.getElementById("checkbox_team");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_technology()
{
//  elements = document.getElementsByClassName("technology");
//  checkbox = document.getElementById("checkbox_technology");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_owner()
{
//  elements = document.getElementsByClassName("owner");
//  checkbox = document.getElementById("checkbox_owner");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_manager()
{
//  elements = document.getElementsByClassName("manager");
//  checkbox = document.getElementById("checkbox_manager");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_submitted_by()
{
//  elements = document.getElementsByClassName("submitted_by");
//  checkbox = document.getElementById("checkbox_submitted_by");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_scoring_method()
{
//  elements = document.getElementsByClassName("scoring_method");
//  checkbox = document.getElementById("checkbox_scoring_method");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_calculated_risk()
{
//  elements = document.getElementsByClassName("calculated_risk");
//  checkbox = document.getElementById("checkbox_calculated_risk");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_residual_risk()
{
//  elements = document.getElementsByClassName("residual_risk");
//  checkbox = document.getElementById("checkbox_residual_risk");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_submission_date()
{
//  elements = document.getElementsByClassName("submission_date");
//  checkbox = document.getElementById("checkbox_submission_date");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_review_date()
{
//  elements = document.getElementsByClassName("review_date");
//  checkbox = document.getElementById("checkbox_review_date");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_project()
{
//  elements = document.getElementsByClassName("project");
//  checkbox = document.getElementById("checkbox_project");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_mitigation_planned()
{
//  elements = document.getElementsByClassName("mitigation_planned");
//  checkbox = document.getElementById("checkbox_mitigation_planned");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_management_review()
{
//  elements = document.getElementsByClassName("management_review");
//  checkbox = document.getElementById("checkbox_management_review");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_days_open()
{
//  elements = document.getElementsByClassName("days_open");
//  checkbox = document.getElementById("checkbox_days_open");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_next_review_date()
{
//  elements = document.getElementsByClassName("next_review_date");
//  checkbox = document.getElementById("checkbox_next_review_date");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_next_step()
{
//  elements = document.getElementsByClassName("next_step");
//  checkbox = document.getElementById("checkbox_next_step");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_affected_assets()
{
//  elements = document.getElementsByClassName("affected_assets");
//  checkbox = document.getElementById("AffectedAssets");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_risk_assessment(){
//  elements = document.getElementsByClassName("risk_assessment");
//  checkbox = document.getElementById("RiskAssessment");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_additional_notes(){
//  elements = document.getElementsByClassName("additional_notes");
//  checkbox = document.getElementById("AdditionalNotes");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_current_solution(){
//  elements = document.getElementsByClassName("current_solution");
//  checkbox = document.getElementById("CurrentSolution");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_security_recommendations(){
//  elements = document.getElementsByClassName("security_recommendations");
//  checkbox = document.getElementById("SecurityRecommendations");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_security_requirements(){
//  elements = document.getElementsByClassName("security_requirements");
//  checkbox = document.getElementById("SecurityRequirements");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_planning_strategy()
{
//  elements = document.getElementsByClassName("planning_strategy");
//  checkbox = document.getElementById("checkbox_planning_strategy");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_mitigation_effort()
{
//  elements = document.getElementsByClassName("mitigation_effort");
//  checkbox = document.getElementById("checkbox_mitigation_effort");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_mitigation_cost()
{
//  elements = document.getElementsByClassName("mitigation_cost");
//  checkbox = document.getElementById("checkbox_mitigation_cost");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_mitigation_owner()
{
//  elements = document.getElementsByClassName("mitigation_owner");
//  checkbox = document.getElementById("checkbox_mitigation_owner");

//  if(checkbox.checked)
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}

function check_mitigation_team()
{
//  elements = document.getElementsByClassName("mitigation_team");
//  checkbox = document.getElementById("checkbox_mitigation_team");

//  if(checkbox.checked)
//  { 
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "";
//    }
//  }
//  else
//  {
//    for(i=0; i<elements.length; i++)
//    {
//      elements[i].style.display = "none";
//    }
//  }
}
$(document).ready(function(){
    if($(".risk-datatable").length){
        var sortColumns = [["calculated_risk", "desc"], ["id", "asc"], ["subject", "asc"], ["residual_risk", "desc"]];
        var defaultSortColumnIndex = 0;
        var defaultSortColumn = sortColumns[$("#sort").val()];
        var columnOptions = [];
        var columnNames = [];
        $(".risk-datatable tr.main th").each(function(index){
            var name = $(this).data('name');
            if(columnNames.indexOf(name) > -1){
                return;
            }
            columnNames.push(name);
//            if($("form[name='get_risks_by'] input.hidden-checkbox[name='"+ name +"']").length > 0 &&  !$("form[name='get_risks_by'] input.hidden-checkbox[name='"+ name +"']").is(':checked')){
            if(!$("form[name='get_risks_by'] input.hidden-checkbox[name='"+ name +"']").is(':checked')){
                columnOptions.push(index);
            }
            if(name == defaultSortColumn[0]) {
                defaultSortColumnIndex = index;
            }
        })
        
        
        var riskDataTables = [];
        $(".risk-datatable").each(function(index){
            var $this = $(this);
            var riskDatatable = $(this).DataTable({
                scrollX: true,
                bFilter: false,
                bLengthChange: false,
                processing: true,
                serverSide: true,
                bSort: true,
//                ordering: false,
                pagingType: "full_numbers",
                dom : "flrti<'#view-all-"+ index +".view-all'>p",
                ajax: {
                    url: BASE_URL + '/api/reports/dynamic',
                    type: "post",
                    data: function(d){
                        d.status            = $("#status").val();
                        d.group             = $("#group").val();
                        d.sort              = $("#sort").val();
                        d.affected_asset    = $("#affected_asset").val();
                        d.group_value       = $this.data('group');
                    }
                },
                order: [[defaultSortColumnIndex, defaultSortColumn[1]]],
                columnDefs : [
                    {
                        "targets" : columnOptions,
                        "visible" : false
                    },
                    {
                        "targets" : 15,
                        "className" : "risk-cell",
                    },
                    {
                        "targets" : 16,
                        "className" : "risk-cell",
                    },
                    {
                        "targets" : [21, 22, 23, 26, 27, 28, 29, 30],
                        "orderable" : false,
                    },
                ]
            });
            riskDatatable.on('draw', function(e, settings){
                if(settings._iDisplayLength == -1){
                    $("#" + settings.sTableId + "_wrapper").find(".paginate_button.current").removeClass("current");
                }
                $('.paginate_button.first').html('<i class="fa fa-chevron-left"></i><i class="fa fa-chevron-left"></i>');
                $('.paginate_button.previous').html('<i class="fa fa-chevron-left"></i>');

                $('.paginate_button.last').html('<i class="fa fa-chevron-right"></i><i class="fa fa-chevron-right"></i>');
                $('.paginate_button.next').html('<i class="fa fa-chevron-right"></i>');
            })
            riskDataTables.push(riskDatatable);
        })
        $('.view-all').html("All");
        
        $("form[name='get_risks_by'] .hidden-checkbox").click(function(e){
            
            for(var key in riskDataTables){
                var column = riskDataTables[key].column("th[data-name='"+ $(this).attr('name') +"']");
                if($(this).is(':checked')){
                    column.visible(true);
                }else{
                    column.visible(false);
                }
            }
            
            var checkBoxes = $("form[name='get_risks_by'] .hidden-checkbox");
            var viewColumns = [];
            checkBoxes.each(function(){
                if($(this).is(':checked'))
                    viewColumns.push($(this).attr('name'));
            })
            $.ajax({
                type: "POST",
                url: BASE_URL + "/api/set_custom_display",
                data: {
                    columns: viewColumns,
                },
                success: function(data){
                    console.log('success')
                },
                error: function(xhr,status,error){
                    if(!retryCSRF(xhr, this))
                    {
                    }
                }
            });
        })
        
        $(".expand-all").click(function(e){
            e.preventDefault();
            $(".view-all").click();

        })
        
        $(".view-all").click(function(){
            var $this = $(this);
            var index = $(this).attr('id').replace("view-all-", "");
            var oSettings =  riskDataTables[index].settings();
            oSettings[0]._iDisplayLength = -1;
            riskDataTables[index].draw()
            $this.addClass("current");
        })
        
        $("body").on("click", "span > .paginate_button", function(){
            var index = $(this).attr('aria-controls').replace("DataTables_Table_", "");

            var oSettings =  riskDataTables[index].settings();
            if(oSettings[0]._iDisplayLength == -1){
                $(this).parents(".dataTables_wrapper").find('.view-all').removeClass('current');
                oSettings[0]._iDisplayLength = 10;
                riskDataTables[index].draw()
            }
            
        })
    }
    
    $("#export-dynamic-risk-report").click(function(e){
        document.get_risks_by.action += "?option=download";
        document.get_risks_by.submit();
        document.get_risks_by.action = "";
//        document.location.href = "dynamic_risk_report.php?option";
    })
})
